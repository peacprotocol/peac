{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://peac.dev/schemas/receipt/0.9.json",
  "title": "PEAC Receipt Envelope",
  "description": "Normative JSON Schema for PEAC receipts (wire format: peac.receipt/0.9)",
  "type": "object",
  "required": ["auth"],
  "properties": {
    "auth": {
      "$ref": "#/$defs/AuthContext"
    },
    "evidence": {
      "$ref": "#/$defs/EvidenceBlock"
    },
    "meta": {
      "$ref": "#/$defs/MetadataBlock"
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "evidence": {
            "type": "object",
            "required": ["payment"]
          }
        }
      },
      "then": {
        "properties": {
          "auth": {
            "type": "object",
            "required": ["control"]
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "auth": {
            "type": "object",
            "required": ["enforcement"],
            "properties": {
              "enforcement": {
                "type": "object",
                "properties": {
                  "method": {
                    "const": "http-402"
                  }
                }
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "auth": {
            "type": "object",
            "required": ["control"]
          }
        }
      }
    }
  ],
  "$defs": {
    "AuthContext": {
      "type": "object",
      "description": "Authentication and authorization context (normative)",
      "required": ["iss", "aud", "sub", "iat", "rid", "policy_hash", "policy_uri"],
      "properties": {
        "iss": {
          "type": "string",
          "description": "Issuer identifier (RFC 7519)",
          "format": "uri"
        },
        "aud": {
          "type": "string",
          "description": "Audience identifier (RFC 7519)",
          "format": "uri"
        },
        "sub": {
          "type": "string",
          "description": "Subject identifier - MUST identify agent/client/service, SHOULD NOT contain human PII"
        },
        "iat": {
          "type": "integer",
          "description": "Issued at timestamp (Unix seconds, RFC 7519)",
          "minimum": 0
        },
        "exp": {
          "type": "integer",
          "description": "Expiration timestamp (Unix seconds, RFC 7519). MUST be >= iat",
          "minimum": 0
        },
        "rid": {
          "type": "string",
          "description": "Receipt ID (ULID format)",
          "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
        },
        "policy_hash": {
          "type": "string",
          "description": "Policy binding hash: base64url(sha256(jcs(policy)))"
        },
        "policy_uri": {
          "type": "string",
          "description": "Policy document location (HTTPS required, see SSRF protections)",
          "format": "uri"
        },
        "control": {
          "$ref": "#/$defs/ControlBlock"
        },
        "ctx": {
          "type": "object",
          "description": "Request context (optional)",
          "properties": {
            "resource": {
              "type": "string",
              "format": "uri"
            },
            "method": {
              "type": "string"
            },
            "tenant_id": {
              "type": "string"
            }
          }
        },
        "binding": {
          "$ref": "#/$defs/TransportBinding"
        },
        "enforcement": {
          "$ref": "#/$defs/Enforcement"
        },
        "parent_rid": {
          "type": "string",
          "description": "Parent receipt ID for chaining (reserved, non-normative in v0.9.x)",
          "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
        },
        "supersedes_rid": {
          "type": "string",
          "description": "Superseded receipt ID (reserved, non-normative in v0.9.x)",
          "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
        },
        "delegation_chain": {
          "type": "array",
          "description": "Delegation chain (reserved, non-normative in v0.9.x)",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "ControlBlock": {
      "type": "object",
      "description": "Control governance block with composable chain",
      "required": ["chain", "decision"],
      "properties": {
        "chain": {
          "type": "array",
          "description": "Ordered control steps (MUST be non-empty)",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/ControlStep"
          }
        },
        "decision": {
          "type": "string",
          "description": "Final decision (MUST be consistent with chain + combinator)",
          "enum": ["allow", "deny", "review"]
        },
        "combinator": {
          "type": "string",
          "description": "Chain combinator logic (defaults to any_can_veto if absent)",
          "enum": ["any_can_veto"],
          "default": "any_can_veto"
        }
      }
    },
    "ControlStep": {
      "type": "object",
      "description": "Single control engine decision",
      "required": ["engine", "result"],
      "properties": {
        "engine": {
          "type": "string",
          "description": "Control engine identifier (vendor-neutral, e.g. 'spend-control-service')",
          "minLength": 1
        },
        "version": {
          "type": "string",
          "description": "Engine version (semver recommended)"
        },
        "policy_id": {
          "type": "string",
          "description": "Policy identifier within engine"
        },
        "result": {
          "type": "string",
          "description": "Engine decision result",
          "enum": ["allow", "deny", "review"]
        },
        "reason": {
          "type": "string",
          "description": "Human-readable reason for decision"
        },
        "limits_snapshot": {
          "description": "Engine-specific limits state (opaque)",
          "type": "object"
        },
        "evidence_ref": {
          "type": "string",
          "description": "Reference to external evidence supporting this decision"
        }
      }
    },
    "Enforcement": {
      "type": "object",
      "description": "Enforcement method - how access control was applied",
      "required": ["method"],
      "properties": {
        "method": {
          "type": "string",
          "description": "Enforcement method identifier (http-402, ap2, tap, manual, none, etc.)"
        },
        "details": {
          "description": "Enforcement-specific details (opaque)"
        }
      }
    },
    "TransportBinding": {
      "type": "object",
      "description": "Transport-level binding (DPoP, HTTP Message Signatures, etc.)",
      "properties": {
        "transport": {
          "type": "string",
          "description": "Transport protocol (http, grpc, websocket, etc.)"
        },
        "method": {
          "type": "string",
          "description": "Binding method (dpop, http-signature, etc.)"
        },
        "evidence": {
          "type": "object",
          "description": "Binding-specific evidence (jkt, nonce for DPoP; signature for HTTP Message Signatures)"
        }
      }
    },
    "EvidenceBlock": {
      "type": "object",
      "description": "Protocol and rail-specific evidence (normative)",
      "properties": {
        "payment": {
          "$ref": "#/$defs/PaymentEvidence"
        },
        "payments": {
          "type": "array",
          "description": "RESERVED: Multi-rail payments - non-normative in v0.9.x, do not rely on semantics",
          "items": {
            "$ref": "#/$defs/PaymentEvidence"
          }
        },
        "attestation": {
          "$ref": "#/$defs/AttestationEvidence"
        },
        "extra": {
          "type": "object",
          "description": "Protocol-specific extra evidence (opaque)"
        }
      }
    },
    "PaymentEvidence": {
      "type": "object",
      "description": "Normalized payment evidence",
      "required": ["rail", "reference", "amount", "currency", "asset", "env"],
      "properties": {
        "rail": {
          "type": "string",
          "description": "Payment rail identifier (vendor-neutral, see registries.json for common values)",
          "minLength": 1
        },
        "reference": {
          "type": "string",
          "description": "Rail-specific payment reference (invoice ID, transaction hash, etc.)",
          "minLength": 1
        },
        "amount": {
          "type": "integer",
          "description": "Amount in smallest currency unit (cents, wei, satoshis, etc.)",
          "minimum": 0
        },
        "currency": {
          "type": "string",
          "description": "Accounting currency (ISO 4217 or similar)",
          "minLength": 1
        },
        "asset": {
          "type": "string",
          "description": "Actual asset transferred (USD, USDC, BTC, ETH, etc.)",
          "minLength": 1
        },
        "env": {
          "type": "string",
          "description": "Environment indicator",
          "enum": ["live", "test"]
        },
        "network": {
          "type": "string",
          "description": "Network identifier for crypto rails (lightning, base-mainnet, ethereum, etc.)"
        },
        "facilitator_ref": {
          "type": "string",
          "description": "Facilitator/gateway reference for multi-party flows"
        },
        "evidence": {
          "description": "Rail-specific payment evidence (opaque)",
          "type": "object"
        }
      }
    },
    "AttestationEvidence": {
      "type": "object",
      "description": "Hardware/platform attestation evidence",
      "required": ["format"],
      "properties": {
        "format": {
          "type": "string",
          "description": "Attestation format (tpm2.0, sgx, nitro, etc.)"
        },
        "evidence": {
          "description": "Format-specific attestation data (opaque)"
        }
      }
    },
    "MetadataBlock": {
      "type": "object",
      "description": "Non-normative metadata (hints, debug, privacy)",
      "properties": {
        "redactions": {
          "type": "array",
          "description": "Redaction hints for privacy-preserving operations",
          "items": {
            "$ref": "#/$defs/RedactionEntry"
          }
        },
        "privacy_budget": {
          "$ref": "#/$defs/PrivacyBudget"
        },
        "debug": {
          "type": "object",
          "description": "Debug information (vendor-specific, non-normative)"
        }
      }
    },
    "RedactionEntry": {
      "type": "object",
      "description": "Redaction hint for a specific field",
      "properties": {
        "pointer": {
          "type": "string",
          "description": "JSON Pointer (RFC 6901) to redactable field"
        },
        "method": {
          "type": "string",
          "description": "Redaction method (hash, omit, aggregate, etc.)"
        }
      }
    },
    "PrivacyBudget": {
      "type": "object",
      "description": "Privacy budget metadata",
      "properties": {
        "k_anonymity": {
          "type": "integer",
          "description": "Minimum k-anonymity guarantee",
          "minimum": 1
        }
      }
    }
  }
}
