# .github/workflows/publish.yml
name: Publish (manual)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (pack only, no publish)'
        type: boolean
        default: false
      dist_tag:
        description: 'npm dist-tag (next for pre-1.0, latest for 1.0+)'
        type: choice
        options:
          - next
          - latest
        default: next

# Prevent concurrent publishes
concurrency:
  group: npm-publish
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write # Required for npm provenance

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - uses: pnpm/action-setup@v4
        # Uses packageManager field from package.json

      - name: Install deps
        run: pnpm -w install --frozen-lockfile

      - name: Run gates (lint, build, typecheck, guard)
        run: |
          pnpm -w lint
          pnpm -w build
          pnpm -w typecheck:core
          ./scripts/guard.sh
          pnpm -w format:check

      - name: Check publish list drift
        run: ./scripts/check-publish-list.sh

      - name: Validate ref for real publish
        if: ${{ !inputs.dry_run }}
        run: |
          REF="${{ github.ref }}"
          echo "Current ref: $REF"
          if [[ ! "$REF" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "FAIL: Real publish (dry_run=false) requires a version tag (v*)."
            echo "Either:"
            echo "  1. Run with dry_run=true for testing, OR"
            echo "  2. Trigger from a tag ref (e.g., v0.9.18)"
            exit 1
          fi
          echo "OK: Running from tag ref"

      - name: Check version integrity (fail-closed)
        if: ${{ !inputs.dry_run }}
        run: |
          TAG_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "")
          ROOT_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "Tag version: ${TAG_VERSION:-none}"
          echo "Root package.json version: $ROOT_VERSION"
          if [ -z "$TAG_VERSION" ]; then
            echo "FAIL: No git tag found. Publishing requires a tagged release."
            exit 1
          fi
          # Allow infrastructure patches: v0.9.18.1 can publish 0.9.18 packages
          # Extract base version (first 3 components: major.minor.patch)
          TAG_BASE=$(echo "$TAG_VERSION" | sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [ "$TAG_BASE" != "$ROOT_VERSION" ]; then
            echo "FAIL: Tag base version ($TAG_BASE from $TAG_VERSION) does not match root package.json ($ROOT_VERSION)"
            exit 1
          fi
          echo "OK: Tag $TAG_VERSION is compatible with package version $ROOT_VERSION"
          ./scripts/check-version-integrity.sh "$ROOT_VERSION"

      - name: Dry run - pack all public packages
        if: ${{ inputs.dry_run }}
        run: |
          echo "=== DRY RUN: Packing packages ==="
          pnpm \
            --filter @peac/kernel \
            --filter @peac/schema \
            --filter @peac/crypto \
            --filter @peac/protocol \
            --filter @peac/control \
            --filter @peac/policy-kit \
            --filter @peac/http-signatures \
            --filter @peac/jwks-cache \
            --filter @peac/mappings-mcp \
            --filter @peac/mappings-acp \
            --filter @peac/mappings-rsl \
            --filter @peac/mappings-tap \
            --filter @peac/rails-x402 \
            --filter @peac/rails-stripe \
            --filter @peac/server \
            --filter @peac/cli \
            --filter @peac/core \
            --filter @peac/receipts \
            --filter @peac/disc \
            --filter @peac/pay402 \
            --filter @peac/pref \
            --filter @peac/sdk \
            exec pnpm pack

      - name: Configure npm auth
        if: ${{ !inputs.dry_run }}
        run: |
          echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > ~/.npmrc
          pnpm config set publish-branch "main|master|release/.*"

      - name: Publish all public packages
        if: ${{ !inputs.dry_run }}
        run: |
          pnpm -r \
            --filter @peac/kernel \
            --filter @peac/schema \
            --filter @peac/crypto \
            --filter @peac/protocol \
            --filter @peac/control \
            --filter @peac/policy-kit \
            --filter @peac/http-signatures \
            --filter @peac/jwks-cache \
            --filter @peac/mappings-mcp \
            --filter @peac/mappings-acp \
            --filter @peac/mappings-rsl \
            --filter @peac/mappings-tap \
            --filter @peac/rails-x402 \
            --filter @peac/rails-stripe \
            --filter @peac/server \
            --filter @peac/cli \
            --filter @peac/core \
            --filter @peac/receipts \
            --filter @peac/disc \
            --filter @peac/pay402 \
            --filter @peac/pref \
            --filter @peac/sdk \
            publish --access public --tag ${{ inputs.dist_tag }} --no-git-checks
        env:
          NPM_CONFIG_PROVENANCE: true

      - name: Verify published versions
        if: ${{ !inputs.dry_run }}
        run: |
          echo "=== Verifying published packages ==="
          for pkg in kernel schema crypto protocol control policy-kit http-signatures jwks-cache sdk; do
            echo "@peac/$pkg: $(pnpm view @peac/$pkg version 2>/dev/null || echo 'not found')"
          done
