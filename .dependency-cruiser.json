{
  "forbidden": [
    {
      "name": "no-app-imports-in-packages",
      "severity": "error",
      "comment": "Packages should not import from apps",
      "from": { "path": "^packages/" },
      "to": { "path": "^apps/" }
    },
    {
      "name": "no-circular",
      "severity": "error",
      "comment": "No circular dependencies allowed (net/node package exempt - type-only internal cycles)",
      "from": { "pathNot": "^packages/net/node/" },
      "to": { "circular": true }
    },
    {
      "name": "no-legacy-imports",
      "severity": "error",
      "comment": "No imports from legacy pkgs/ directory",
      "from": { "path": ".*" },
      "to": { "path": "^pkgs/" }
    },
    {
      "name": "kernel-no-upward",
      "severity": "error",
      "comment": "L0 kernel must not import any higher layer. [^/]* suffix on telemetry/middleware matches hyphenated variants (telemetry-otel, middleware-core, middleware-express) since bare 'middleware/' would not match 'middleware-core/'.",
      "from": {
        "path": "^packages/kernel/src/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/(schema|crypto|protocol|telemetry[^/]*|control|middleware[^/]*|rails|mappings|adapters|server|cli)/"
      }
    },
    {
      "name": "schema-no-upward",
      "severity": "error",
      "comment": "L1 schema must not import L2+ layers",
      "from": {
        "path": "^packages/schema/src/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/(crypto|protocol|telemetry[^/]*|control|middleware[^/]*|rails|mappings|adapters|server|cli)/"
      }
    },
    {
      "name": "crypto-no-upward",
      "severity": "error",
      "comment": "L2 crypto must not import L3+ layers",
      "from": {
        "path": "^packages/crypto/src/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/(protocol|control|telemetry[^/]*|middleware[^/]*|rails|mappings|adapters|server|cli)/"
      }
    },
    {
      "name": "protocol-no-upward",
      "severity": "error",
      "comment": "L3 protocol must not import L3.5+ layers",
      "from": {
        "path": "^packages/protocol/src/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/(middleware[^/]*|rails|mappings|adapters|server|cli)/"
      }
    },
    {
      "name": "control-no-upward",
      "severity": "error",
      "comment": "L3 control must not import L3.5+ layers",
      "from": {
        "path": "^packages/control/src/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/(middleware[^/]*|rails|mappings|adapters|server|cli)/"
      }
    },
    {
      "name": "telemetry-no-upward",
      "severity": "error",
      "comment": "Telemetry packages must not import L3+ layers (would create cycle or violate boundary)",
      "from": {
        "path": "^packages/telemetry[^/]*/src/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/(protocol|control|middleware[^/]*|rails|mappings|adapters|server|cli)/"
      }
    },
    {
      "name": "middleware-no-upward",
      "severity": "error",
      "comment": "L3.5 middleware may import protocol/control (down) but not rails/mappings/adapters/server/cli",
      "from": {
        "path": "^packages/middleware[^/]*/src/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/(rails|mappings|adapters|server|cli)/"
      }
    },
    {
      "name": "adapters-no-upward",
      "severity": "error",
      "comment": "L4 adapters/rails/mappings must not import server or cli",
      "from": {
        "path": "^packages/(adapters|rails|mappings)/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/(server|cli)/"
      }
    },
    {
      "name": "no-l5-import-from-libraries",
      "severity": "error",
      "comment": "Catch-all: library/utility packages must not import L5 application packages. Covers pillar packages, jwks-cache, pay402, sdk-js, etc. that lack individual layer rules.",
      "from": {
        "path": "^packages/(?!server/|cli/)",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/(server|cli)/"
      }
    },
    {
      "name": "server-no-cli",
      "severity": "error",
      "comment": "L5 horizontal isolation: server must not import cli",
      "from": {
        "path": "^packages/server/src/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/cli/"
      }
    },
    {
      "name": "cli-no-server",
      "severity": "error",
      "comment": "L5 horizontal isolation: cli must not import server",
      "from": {
        "path": "^packages/cli/src/",
        "pathNot": "\\.(test|spec)\\.ts$"
      },
      "to": {
        "path": "^packages/server/"
      }
    }
  ],
  "options": {
    "doNotFollow": {
      "path": "node_modules"
    },
    "exclude": {
      "path": ["node_modules", "\\.d\\.ts$", "__tests__", "dist", "archive"]
    },
    "includeOnly": {
      "path": "^packages/([^/]+/){1,4}src/"
    },
    "tsPreCompilationDeps": true,
    "tsConfig": {
      "fileName": "tsconfig.json"
    },
    "combinedDependencies": true,
    "reporterOptions": {
      "text": {
        "highlightFocused": true
      }
    }
  }
}
